# Preliminaries -----------------------------------------------------------
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, readr, readxl, scales, acs, tidyr)

##Question 1: Plot the share of the adult population with direct purchase health insurance over time.

final.insurance <- read_tsv("data/output/acs_insurance.txt")

library(ggplot2)
library(dplyr)

# Calculate the share of adult population with direct purchase health insurance for each year
final.insurance <- final.insurance %>%
  group_by(year) %>%
  summarise(total_adult_pop = sum(adult_pop),
            total_direct_ins = sum(ins_direct)) %>%
  mutate(share_direct_ins = total_direct_ins / total_adult_pop)

# Plotting the trend over time
question1 <- ggplot(final.insurance, aes(x = year, y = share_direct_ins)) +
  geom_line() +
  labs(x = "Year", y = "Share of Adult Population with Direct Purchase Health Insurance", 
       title = "Trend of Direct Purchase Health Insurance Over Time")

question1

##Question3: Plot the share of the adult population with Medicaid over time.

library(ggplot2)
final.insurance <- read_tsv("data/output/acs_insurance.txt")

# Plotting the share of the adult population with Medicaid over time
question3 <- ggplot(final.insurance, aes(x = year, y = ins_medicaid)) +
  geom_line() +
  labs(x = "Year", y = "Share of Adult Population with Medicaid", 
       title = "Share of Adult Population with Medicaid Over Time") +
  theme_minimal()

question3

##Question4: Plot the share of uninsured over time, separately by states that expanded Medicaid in 2014 versus those that did not. Drop all states that expanded after 2014.

library(ggplot2)
library(dplyr)

# Read in the data for insurance and Medicaid expansion
final.insurance <- read_tsv('data/output/acs_insurance.txt')
kff.final <- read_tsv('data/output/medicaid_expansion.txt')

# Merge insurance and Medicaid expansion data
final.data <- final.insurance %>%
  left_join(kff.final, by = "State") %>%
  mutate(expand_year = year(date_adopted),
         expand = (year >= expand_year & !is.na(expand_year))) %>%
  rename(expand_ever = expanded)

# Filter out states that expanded Medicaid after 2014
final.data <- final.data %>%
  filter(expand_year <= 2014)

# Plot the share of uninsured over time, separately by Medicaid expansion status
question4 <- final.data %>%
  group_by(State, expand_ever, year) %>%
  summarise(uninsured_share = mean(uninsured, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = uninsured_share, color = expand_ever)) +
  geom_line() +
  labs(title = "Share of Uninsured Over Time by Medicaid Expansion Status",
       x = "Year",
       y = "Share of Uninsured") +
  theme_minimal()

question4



