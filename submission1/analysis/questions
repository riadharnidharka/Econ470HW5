# Preliminaries -----------------------------------------------------------
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, readr, readxl, scales, acs, tidyr)

##Question 1: Plot the share of the adult population with direct purchase health insurance over time.

final.insurance <- read_tsv("data/output/acs_insurance.txt")

library(ggplot2)
library(dplyr)

# Calculate the share of adult population with direct purchase health insurance for each year
final.insurance <- final.insurance %>%
  group_by(year) %>%
  summarise(total_adult_pop = sum(adult_pop),
            total_direct_ins = sum(ins_direct)) %>%
  mutate(share_direct_ins = total_direct_ins / total_adult_pop)

# Plotting the trend over time
question1 <- ggplot(final.insurance, aes(x = year, y = share_direct_ins)) +
  geom_line() +
  labs(x = "Year", y = "Share of Adult Population with Direct Purchase Health Insurance", 
       title = "Trend of Direct Purchase Health Insurance Over Time")

question1

##Question3: Plot the share of the adult population with Medicaid over time.

library(ggplot2)
final.insurance <- read_tsv("data/output/acs_insurance.txt")

# Plotting the share of the adult population with Medicaid over time
question3 <- ggplot(final.insurance, aes(x = year, y = ins_medicaid)) +
  geom_line() +
  labs(x = "Year", y = "Share of Adult Population with Medicaid", 
       title = "Share of Adult Population with Medicaid Over Time") +
  theme_minimal()

question3

##Question4: Plot the share of uninsured over time, separately by states that expanded Medicaid in 2014 versus those that did not. Drop all states that expanded after 2014.

library(tidyverse)  
mcaid.data <- read_tsv("data/output/acs_medicaid.txt")
ins.plot.dat <- mcaid.data %>% filter(expand_year==2014 | is.na(expand_year), !is.na(expand_ever)) %>%
  mutate(perc_unins=uninsured/adult_pop) %>%
  group_by(expand_ever, year) %>% summarize(mean=mean(perc_unins))

question4 <- ggplot(data=ins.plot.dat, aes(x=year,y=mean,group=expand_ever,linetype=expand_ever)) + 
  geom_line() + geom_point() + theme_bw() +
  geom_vline(xintercept=2013.5, color="red") +
  geom_text(data = ins.plot.dat %>% filter(year == 2016), 
            aes(label = c("Non-expansion","Expansion"),
                x = year + 1,
                y = mean)) +
  guides(linetype="none") +
  labs(
    x="Year",
    y="Fraction Uninsured",
    title="Share of Uninsured over Time"
  )
question4

##Question5: Calculate the average percent of uninsured individuals in 2012 and 2015, separately for expansion and non-expansion states. Present your results in a basic 2x2 DD table.

library(tidyverse)

# Read in the data
mcaid.data <- read_tsv("data/output/acs_medicaid.txt")

# Filter the data for the years 2012 and 2015
mcaid.data_filtered <- mcaid.data %>%
  filter(year %in% c(2012, 2015))

# Calculate the difference in the percent uninsured between 2012 and 2015 for each state
mcaid.data_diff <- mcaid.data_filtered %>%
  group_by(State) %>%
  mutate(diff_uninsured = last(uninsured / adult_pop) - first(uninsured / adult_pop))

# Group the data by expand_ever (Medicaid expansion status) and calculate the average difference-in-differences estimator
avg_did <- mcaid.data_diff %>%
  group_by(expand_ever) %>%
  summarise(avg_diff_uninsured = mean(diff_uninsured, na.rm = TRUE))

# Print the result
print(avg_did)




